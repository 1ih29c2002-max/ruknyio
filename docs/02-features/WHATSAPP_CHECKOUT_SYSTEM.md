# 📱 نظام الدفع عبر واتساب - WhatsApp Checkout System

## 📋 نظرة عامة | Overview

هذا المستند يوضح النظام الكامل للشراء من المتجر الإلكتروني باستخدام التحقق عبر واتساب (OTP) مع إمكانية الشراء كضيف دون الحاجة لتسجيل حساب مسبق.

---

## 🎯 الأهداف الرئيسية | Main Objectives

1. **تبسيط عملية الشراء**: السماح للزوار بالشراء دون تسجيل مسبق
2. **التحقق عبر واتساب**: إرسال رمز OTP عبر واتساب (رقم مركزي للمنصة)
3. **إنشاء حساب تلقائي**: إنشاء حساب للمستخدم تلقائياً بعد التحقق
4. **الدفع عند الاستلام**: الدفع نقداً فقط (Cash on Delivery)
5. **إكمال الملف الشخصي**: مطلوب فقط لتتبع الطلبات أو عرض سجل الطلبات

---

## 🔄 مسار العملية الكامل | Complete User Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           مسار الشراء للزائر الجديد                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌────────┐│
│  │ تصفح     │───▶│ إضافة    │───▶│ سلة      │───▶│ إتمام    │───▶│ التحقق ││
│  │ المنتجات │    │ للسلة    │    │ التسوق   │    │ الشراء   │    │ بالهاتف││
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └────────┘│
│                                                                      │      │
│                                                                      ▼      │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌────────┐│
│  │ تأكيد    │◀───│ الدفع    │◀───│ صفحة     │◀───│ إدخال    │◀───│ إرسال  ││
│  │ الطلب    │    │ COD      │    │ العنوان  │    │ OTP      │    │ OTP    ││
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘    └────────┘│
│       │                                                                     │
│       ▼                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                    📱 إشعار واتساب: تم تأكيد طلبك                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📝 المراحل التفصيلية | Detailed Steps

### المرحلة 1: تصفح المنتجات وإضافتها للسلة 🛒

**الحالة**: الزائر غير مسجل

| الخطوة | الوصف | ملاحظات |
|--------|-------|---------|
| 1.1 | تصفح المنتجات في المتجر | لا يتطلب تسجيل |
| 1.2 | عرض تفاصيل المنتج | لا يتطلب تسجيل |
| 1.3 | الضغط على "إضافة للسلة" | حفظ في Local Storage |
| 1.4 | متابعة التسوق أو الذهاب للسلة | السلة محفوظة محلياً |

**ملاحظة تقنية**: 
- السلة للزوار تُحفظ في `localStorage` بالمتصفح
- عند التسجيل، يتم نقل السلة لقاعدة البيانات

---

### المرحلة 2: صفحة إتمام الشراء (Checkout) 🛍️

**الحالة**: الزائر يضغط على "إتمام الشراء"

```
┌─────────────────────────────────────────────────────────────┐
│                    صفحة إتمام الشراء                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              📱 أدخل رقم هاتفك                       │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  🇮🇶 +964  │  7XX XXX XXXX                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  سنرسل لك رمز التحقق عبر واتساب                    │   │
│  │                                                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │           📲 إرسال رمز التحقق                │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  ─────────────────────────────────────────────     │   │
│  │  لديك حساب؟ تسجيل الدخول                          │   │
│  └─────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ملخص الطلب                                         │   │
│  │  ├─ منتج 1: MacBook Pro        2,500,000 IQD       │   │
│  │  ├─ منتج 2: iPhone 15          1,200,000 IQD       │   │
│  │  ├─────────────────────────────────────────────    │   │
│  │  │  المجموع الفرعي:           3,700,000 IQD       │   │
│  │  │  التوصيل:                      15,000 IQD       │   │
│  │  │  ─────────────────────────────────────────      │   │
│  │  │  المجموع الكلي:            3,715,000 IQD       │   │
│  │  └─────────────────────────────────────────────    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### المرحلة 3: إرسال رمز التحقق (OTP) 📲

#### 3.1 إرسال عبر واتساب (الأساسي)

**رسالة واتساب:**
```
مرحباً بك في ركني! 🛒

رمز التحقق الخاص بك هو:

🔐 [ 4 5 8 9 2 1 ]

⏰ صالح لمدة 10 دقائق

⚠️ لا تشارك هذا الرمز مع أي شخص

إذا لم تطلب هذا الرمز، يرجى تجاهل هذه الرسالة.

━━━━━━━━━━━━━━━
ركني - Rukny.io
متجرك الإلكتروني الموثوق
```

#### 3.2 الرسالة البديلة عبر البريد الإلكتروني (Fallback)

**في حالة فشل واتساب:**
```
الموضوع: 🔐 رمز التحقق من ركني - Rukny Verification Code

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

مرحباً بك في ركني! 🛒

رمز التحقق الخاص بك هو:

         ╔═══════════════════════╗
         ║    🔐  4 5 8 9 2 1    ║
         ╚═══════════════════════╝

⏰ هذا الرمز صالح لمدة 10 دقائق فقط

⚠️ تنبيه أمني: لا تشارك هذا الرمز مع أي شخص.
   فريق ركني لن يطلب منك هذا الرمز أبداً.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

إذا لم تطلب هذا الرمز، يرجى تجاهل هذه الرسالة.

مع تحيات فريق ركني
Rukny.io - متجرك الإلكتروني الموثوق

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

### المرحلة 4: إدخال رمز التحقق والتحقق ✅

```
┌─────────────────────────────────────────────────────────────┐
│                    التحقق من رقم الهاتف                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │            📱 أدخل رمز التحقق                        │   │
│  │                                                     │   │
│  │     تم إرسال رمز التحقق إلى +964 7XX XXX XXXX       │   │
│  │                                                     │   │
│  │         ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐ ┌───┐       │   │
│  │         │ 4 │ │ 5 │ │ 8 │ │ 9 │ │ 2 │ │ 1 │       │   │
│  │         └───┘ └───┘ └───┘ └───┘ └───┘ └───┘       │   │
│  │                                                     │   │
│  │     ⏰ الرمز صالح لمدة: 9:45 دقيقة                  │   │
│  │                                                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │              ✅ تأكيد الرمز                  │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │     لم يصلك الرمز؟                                  │   │
│  │     [إعادة الإرسال عبر واتساب] | [إرسال عبر البريد] │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### ماذا يحدث عند التحقق الناجح؟

1. **إنشاء حساب تلقائي** للمستخدم مع:
   - رقم الهاتف (مُحقق)
   - حالة الحساب: `PHONE_VERIFIED`
   - نوع الحساب: `GUEST_CHECKOUT`

2. **إنشاء جلسة مؤقتة** (JWT Token)

3. **نقل السلة** من localStorage إلى قاعدة البيانات

4. **الانتقال لصفحة العنوان**

---

### المرحلة 5: صفحة إدخال العنوان 📍

```
┌─────────────────────────────────────────────────────────────┐
│                    عنوان التوصيل                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  👤 الاسم الكامل *                                  │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  أحمد محمد علي                              │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  🏛️ المحافظة *                                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  بغداد                              ▼       │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  🏙️ المدينة/المنطقة *                              │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  الكرادة                            ▼       │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  📍 العنوان التفصيلي *                              │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  شارع 14 رمضان، قرب جامع الخلاني            │    │   │
│  │  │  عمارة رقم 15، الطابق الثالث                │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  📝 أقرب نقطة دالة (اختياري)                        │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  مقابل مطعم الريف                           │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  ─────────────── أو ───────────────                │   │
│  │                                                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  📍 تحديد موقعي تلقائياً عبر GPS             │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               ← المتابعة للدفع                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### قائمة المحافظات العراقية:

| # | المحافظة | Governorate |
|---|----------|-------------|
| 1 | بغداد | Baghdad |
| 2 | البصرة | Basra |
| 3 | نينوى | Nineveh |
| 4 | أربيل | Erbil |
| 5 | السليمانية | Sulaymaniyah |
| 6 | دهوك | Duhok |
| 7 | كركوك | Kirkuk |
| 8 | الأنبار | Anbar |
| 9 | بابل | Babylon |
| 10 | ديالى | Diyala |
| 11 | ذي قار | Dhi Qar |
| 12 | صلاح الدين | Saladin |
| 13 | كربلاء | Karbala |
| 14 | المثنى | Muthanna |
| 15 | النجف | Najaf |
| 16 | القادسية | Qadisiyyah |
| 17 | ميسان | Maysan |
| 18 | واسط | Wasit |

---

### المرحلة 6: صفحة الدفع (Cash on Delivery) 💳

```
┌─────────────────────────────────────────────────────────────┐
│                    إتمام الدفع                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📋 ملخص الطلب                                      │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │                                                     │   │
│  │  🏪 متجر: تكنو بلس                                  │   │
│  │  ├─ MacBook Pro M3 (×1)         2,500,000 IQD      │   │
│  │  └─ iPhone 15 Pro (×1)          1,200,000 IQD      │   │
│  │                                                     │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  المجموع الفرعي:               3,700,000 IQD       │   │
│  │  رسوم التوصيل (بغداد):            15,000 IQD       │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  💰 المجموع الكلي:             3,715,000 IQD       │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📍 عنوان التوصيل                                   │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  👤 أحمد محمد علي                                   │   │
│  │  📱 +964 770 123 4567                               │   │
│  │  🏛️ بغداد - الكرادة                                 │   │
│  │  📍 شارع 14 رمضان، قرب جامع الخلاني                 │   │
│  │     عمارة رقم 15، الطابق الثالث                     │   │
│  │                                           [تعديل]   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  💳 طريقة الدفع                                     │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │                                                     │   │
│  │  ◉ 💵 الدفع نقداً عند الاستلام (COD)               │   │
│  │                                                     │   │
│  │    ادفع نقداً عند استلام طلبك                       │   │
│  │    ⚠️ يرجى تحضير المبلغ المطلوب بالضبط              │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📝 ملاحظات على الطلب (اختياري)                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  يرجى الاتصال قبل التوصيل                   │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ☑️ أوافق على شروط الاستخدام وسياسة الخصوصية        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │       🛒 تأكيد الطلب والدفع عند الاستلام            │   │
│  │              💰 3,715,000 IQD                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

### المرحلة 7: تأكيد الطلب 🎉

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│                    🎉 تم تأكيد طلبك!                        │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│         ┌───────────────────────────────────────┐           │
│         │                                       │           │
│         │            ✅                         │           │
│         │                                       │           │
│         │     شكراً لك على طلبك!               │           │
│         │                                       │           │
│         │   رقم الطلب: ORD-20260113-7845       │           │
│         │                                       │           │
│         └───────────────────────────────────────┘           │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📱 تم إرسال تفاصيل الطلب إلى واتساب               │   │
│  │     +964 770 123 4567                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📦 الخطوة التالية                                  │   │
│  │  ─────────────────────────────────────────────────  │   │
│  │  سيتم التواصل معك خلال 24 ساعة لتأكيد موعد         │   │
│  │  التوصيل. يرجى تحضير المبلغ نقداً:                  │   │
│  │                                                     │   │
│  │           💰 3,715,000 IQD                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌──────────────────┐  ┌──────────────────┐                │
│  │  🏠 الصفحة       │  │  📋 تتبع الطلب    │                │
│  │    الرئيسية      │  │                  │                │
│  └──────────────────┘  └──────────────────┘                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### رسالة تأكيد الطلب عبر واتساب:

```
🎉 تم تأكيد طلبك بنجاح!

━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 تفاصيل الطلب:
رقم الطلب: ORD-20260113-7845
التاريخ: 13 يناير 2026

🛒 المنتجات:
• MacBook Pro M3 - 2,500,000 IQD
• iPhone 15 Pro - 1,200,000 IQD

💰 المجموع: 3,715,000 IQD
(شامل التوصيل)

📍 عنوان التوصيل:
بغداد - الكرادة
شارع 14 رمضان، قرب جامع الخلاني

💳 طريقة الدفع: نقداً عند الاستلام

━━━━━━━━━━━━━━━━━━━━━━━━━━━

📞 سيتم التواصل معك خلال 24 ساعة لتأكيد موعد التوصيل

لتتبع طلبك: rukny.io/track/ORD-20260113-7845

━━━━━━━━━━━━━━━━━━━━━━━━━━━
ركني - Rukny.io 🛒
```

---

## 📊 سيناريو تتبع الطلب والملف الشخصي

### عندما يريد المستخدم تتبع الطلب أو عرض الطلبات:

```
┌─────────────────────────────────────────────────────────────┐
│                    👤 إكمال الملف الشخصي                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  لتتبع طلباتك وعرض سجل المشتريات، يرجى إكمال       │   │
│  │  ملفك الشخصي:                                      │   │
│  │                                                     │   │
│  │  📧 البريد الإلكتروني *                             │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  ahmed@example.com                          │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  🔐 كلمة المرور *                                   │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  ••••••••••••                               │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  🔐 تأكيد كلمة المرور *                             │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │  ••••••••••••                               │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  📷 صورة شخصية (اختياري)                            │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │        📤 رفع صورة                          │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │            ✅ إكمال الملف الشخصي             │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                     │   │
│  │  ─────────────────────────────────────────────     │   │
│  │  ⏭️ تخطي الآن (ستحتاج لإكماله لاحقاً)              │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔔 إشعارات حالة الطلب عبر واتساب

### 1. الطلب قيد المعالجة:
```
📦 تحديث على طلبك

رقم الطلب: ORD-20260113-7845

✅ حالة الطلب: قيد المعالجة

جاري تحضير طلبك للشحن. سنخبرك عند شحنه.

━━━━━━━━━━━━━━━
ركني - Rukny.io
```

### 2. تم شحن الطلب:
```
🚚 طلبك في الطريق!

رقم الطلب: ORD-20260113-7845

📦 حالة الطلب: تم الشحن

طلبك الآن مع شركة التوصيل وسيصلك قريباً.

📍 للتتبع: rukny.io/track/ORD-20260113-7845

━━━━━━━━━━━━━━━
ركني - Rukny.io
```

### 3. جاري التوصيل:
```
🚗 مندوب التوصيل في الطريق!

رقم الطلب: ORD-20260113-7845

📍 طلبك قريب منك!
المندوب في طريقه إليك الآن.

💰 يرجى تحضير المبلغ: 3,715,000 IQD

📞 رقم المندوب: +964 770 XXX XXXX

━━━━━━━━━━━━━━━
ركني - Rukny.io
```

### 4. تم التوصيل:
```
✅ تم توصيل طلبك بنجاح!

رقم الطلب: ORD-20260113-7845

شكراً لتسوقك من ركني! 🛒

⭐ ما رأيك بتجربة التسوق؟
شاركنا رأيك: rukny.io/review/ORD-20260113-7845

━━━━━━━━━━━━━━━
ركني - Rukny.io
```

---

## 🔧 التفاصيل التقنية | Technical Details

### هيكل قاعدة البيانات المطلوب:

```prisma
// إضافات على schema.prisma

model User {
  // ... الحقول الموجودة
  phoneNumber       String?   @unique
  phoneVerified     Boolean   @default(false)
  phoneVerifiedAt   DateTime?
  accountType       AccountType @default(REGULAR)
  
  // علاقات
  whatsapp_otps     WhatsappOtp[]
}

enum AccountType {
  REGULAR           // حساب عادي مسجل
  GUEST_CHECKOUT    // حساب ضيف من الشراء
}

model WhatsappOtp {
  id          String   @id @default(uuid())
  userId      String?
  phoneNumber String
  code        String
  type        OtpType
  attempts    Int      @default(0)
  verified    Boolean  @default(false)
  verifiedAt  DateTime?
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  
  // Fallback tracking
  sentVia     MessageChannel @default(WHATSAPP)
  
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([phoneNumber, code])
  @@index([expiresAt])
}

enum OtpType {
  CHECKOUT          // للشراء
  LOGIN             // لتسجيل الدخول
  VERIFICATION      // للتحقق العام
}

enum MessageChannel {
  WHATSAPP
  EMAIL
  SMS
}

// إشعارات واتساب
model WhatsappNotification {
  id          String   @id @default(uuid())
  userId      String?
  phoneNumber String
  type        NotificationType
  template    String
  content     String   @db.Text
  status      NotificationStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  failedAt    DateTime?
  errorMessage String?
  createdAt   DateTime @default(now())
  
  user        User?    @relation(fields: [userId], references: [id])
  
  @@index([phoneNumber])
  @@index([status])
}

enum NotificationType {
  OTP
  ORDER_CONFIRMED
  ORDER_PROCESSING
  ORDER_SHIPPED
  ORDER_OUT_FOR_DELIVERY
  ORDER_DELIVERED
  ORDER_CANCELLED
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}
```

### API Endpoints المطلوبة:

```
POST   /auth/checkout/request-otp     # طلب OTP للشراء
POST   /auth/checkout/verify-otp      # التحقق من OTP
POST   /auth/checkout/resend-otp      # إعادة إرسال OTP
POST   /checkout/address              # حفظ العنوان
POST   /checkout/complete             # إتمام الطلب
GET    /orders/track/:orderNumber     # تتبع الطلب (عام)
POST   /profile/complete              # إكمال الملف الشخصي
```

### WhatsApp Service APIs:

```
POST   /whatsapp/send/text            # إرسال رسالة نصية
POST   /whatsapp/send/otp             # إرسال OTP
POST   /whatsapp/send/order-update    # إرسال تحديث طلب
GET    /whatsapp/session/check        # فحص حالة الجلسة
POST   /whatsapp/session/generate-qr  # توليد QR جديد
```

---

## 🔐 اعتبارات الأمان | Security Considerations

| الاعتبار | التفاصيل |
|----------|----------|
| Rate Limiting | 3 طلبات OTP كحد أقصى لكل رقم هاتف في 15 دقيقة |
| Code Expiry | رمز OTP صالح لمدة 10 دقائق فقط |
| Max Attempts | 3 محاولات خاطئة = طلب رمز جديد |
| Phone Format | التحقق من صيغة الرقم العراقي (+964) |
| Blacklist | حظر الأرقام المشبوهة |
| Fallback | التحويل للبريد الإلكتروني عند فشل واتساب |
| Session | جلسة مؤقتة تنتهي بعد إتمام الطلب |

---

## 📱 متطلبات واتساب | WhatsApp Requirements

### الرقم المركزي للمنصة:
- رقم واتساب مخصص للمنصة
- يُستخدم لجميع الإشعارات والتحققات
- يجب ربطه بـ WhatsApp Business API

### Session Management:
```javascript
// فحص حالة الجلسة دورياً
const checkSession = async () => {
  const response = await whatsappApi.checkSession(SESSION_ID);
  if (!response.connected) {
    // إعادة توليد QR وإرسال تنبيه للمدير
    await notifyAdmin('WhatsApp session disconnected');
    await whatsappApi.generateQR(SESSION_ID);
  }
};

// جدولة الفحص كل 5 دقائق
setInterval(checkSession, 5 * 60 * 1000);
```

---

## 🔄 Fallback Strategy | استراتيجية البديل

```
┌─────────────────────────────────────────────────────────────┐
│                    استراتيجية Fallback                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│      ┌─────────────┐                                        │
│      │ إرسال OTP   │                                        │
│      └──────┬──────┘                                        │
│             │                                               │
│             ▼                                               │
│      ┌─────────────┐     ✅ نجح                            │
│      │  واتساب     │────────────▶ تم الإرسال               │
│      └──────┬──────┘                                        │
│             │ ❌ فشل                                        │
│             ▼                                               │
│      ┌─────────────┐     ✅ نجح                            │
│      │ البريد      │────────────▶ تم الإرسال               │
│      │ الإلكتروني  │             (مع إشعار المستخدم)        │
│      └──────┬──────┘                                        │
│             │ ❌ فشل                                        │
│             ▼                                               │
│      ┌─────────────┐                                        │
│      │ رسالة خطأ   │                                        │
│      │ + تنبيه     │                                        │
│      │ المدير      │                                        │
│      └─────────────┘                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### كود Fallback:

```typescript
async sendOTP(phoneNumber: string, email?: string): Promise<OTPResult> {
  // محاولة إرسال عبر واتساب
  try {
    const whatsappResult = await this.whatsappService.sendOTP(phoneNumber, otp);
    if (whatsappResult.success) {
      return { success: true, channel: 'WHATSAPP' };
    }
  } catch (error) {
    console.error('WhatsApp OTP failed:', error);
  }

  // Fallback إلى البريد الإلكتروني
  if (email) {
    try {
      await this.emailService.sendOTP(email, otp);
      return { 
        success: true, 
        channel: 'EMAIL',
        message: 'تم إرسال الرمز إلى بريدك الإلكتروني لأن واتساب غير متاح حالياً'
      };
    } catch (error) {
      console.error('Email OTP failed:', error);
    }
  }

  // إخطار المدير
  await this.notifyAdmin('OTP sending failed for: ' + phoneNumber);
  
  return { 
    success: false, 
    message: 'حدث خطأ في إرسال رمز التحقق. يرجى المحاولة لاحقاً.' 
  };
}
```

---

## 📋 ملخص المسار الكامل | Complete Flow Summary

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         مسار الشراء الكامل                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1️⃣ تصفح وإضافة للسلة ──▶ 2️⃣ Checkout ──▶ 3️⃣ إدخال رقم الهاتف         │
│                                                     │                   │
│                                                     ▼                   │
│  6️⃣ تأكيد الطلب ◀── 5️⃣ صفحة الدفع ◀── 4️⃣ صفحة العنوان ◀── ✅ OTP     │
│        │               (COD)            │                               │
│        │                                │                               │
│        ▼                                │                               │
│  📱 إشعار واتساب                         │                               │
│  "تم تأكيد طلبك"                         │                               │
│        │                                │                               │
│        ▼                                ▼                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    الإجراءات اللاحقة                             │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  📦 تتبع الطلب    │  يتطلب إكمال الملف الشخصي (اختياري)        │   │
│  │  📋 عرض الطلبات  │  يتطلب إكمال الملف الشخصي (اختياري)        │   │
│  │  🔄 إعادة الطلب   │  يتطلب تسجيل الدخول                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## ✅ قائمة التحقق للتنفيذ | Implementation Checklist

- [ ] إنشاء WhatsApp Service Module
- [ ] إنشاء Checkout OTP endpoints
- [ ] تحديث User model للحسابات الضيف
- [ ] إنشاء صفحة Checkout الجديدة
- [ ] إنشاء صفحة إدخال OTP
- [ ] إنشاء صفحة العنوان
- [ ] إنشاء صفحة الدفع (COD)
- [ ] إنشاء صفحة تأكيد الطلب
- [ ] إنشاء صفحة إكمال الملف الشخصي
- [ ] تنفيذ إشعارات حالة الطلب
- [ ] تنفيذ Fallback للبريد الإلكتروني
- [ ] اختبار كامل للمسار

---

## 📞 الدعم والتواصل

في حالة وجود أي استفسارات أو مشاكل تقنية:
- فريق التطوير: dev@rukny.io
- الدعم الفني: support@rukny.io

---

**تاريخ الإنشاء**: 13 يناير 2026  
**الإصدار**: 1.0  
**الحالة**: قيد المراجعة
