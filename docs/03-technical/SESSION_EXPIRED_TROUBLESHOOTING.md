# ๐ Session Expired Error - Troubleshooting Guide

## ุงููุดููุฉ
```
UnauthorizedException: ุงูุชูุช ุงูุฌูุณุฉ. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
```

## ุงูุฃุณุจุงุจ ุงููุญุชููุฉ

### 1. ุงูุชูุงุก ุตูุงุญูุฉ Refresh Token
**ุงูุณุจุจ:** Refresh Token ูู ุตูุงุญูุฉ 30 ูููุ ุจุนุฏูุง ูุชู ุฅุจุทุงู ุงูุฌูุณุฉ ุชููุงุฆูุงู.

**ุงูุญู:**
- ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
- ุงูุฌูุณุฉ ุงูุฌุฏูุฏุฉ ุณุชููู ุตุงูุญุฉ ููุฏุฉ 30 ููู

### 2. ุงูุฌูุณุฉ ููุจุทูุฉ (Revoked)
**ุงูุฃุณุจุงุจ ุงููุญุชููุฉ:**
- ุงููุณุชุฎุฏู ุณุฌู ุฎุฑูุฌ ูู ุฌูุงุฒ ุขุฎุฑ
- ุชู ุงูุชุดุงู ูุดุงุท ูุดุจูู (Token Theft)
- ุชุฌุงูุฒ ุงูุญุฏ ุงูุฃูุตู ููุชุฏููุฑ (100 rotation)

**ุงูุญู:**
```bash
# ุชูุธูู ุงูุฌูุณุงุช ุงูููุชููุฉ
npm run cleanup:sessions
```

### 3. Refresh Token ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
**ุงูุณุจุจ:** Cookie ูุญุฐูู ุฃู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชู ุชูุธูููุง

**ุงูุญู:**
- ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู

---

## ๐ง ุฃุฏูุงุช ุงูุชุดุฎูุต

### 1. ุชุดุบูู Script ุชูุธูู ุงูุฌูุณุงุช
```bash
cd apps/api
npm run ts-node src/scripts/cleanup-sessions.ts
```

**ุงููุธุงุฆู:**
- โ ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูุฌูุณุงุช (ูุดุทุฉ/ููุจุทูุฉ)
- โ ุญุฐู ุงูุฌูุณุงุช ุงูููุชููุฉ (ุฃูุซุฑ ูู 7 ุฃูุงู)
- โ ุฅุจุทุงู ุงูุฌูุณุงุช ุงูููุชููุฉ
- โ ุนุฑุถ ุงูุฌูุณุงุช ุงููุดุทุฉ ูุน ุงูุชูุงุตูู
- โ ุนุฑุถ ุนุฏุฏ ุงููุณุชุฎุฏููู ุงููุดุทูู

### 2. ูุญุต Logs
```bash
# Backend logs
[Nest] ERROR [TokenService] โ Session is revoked: <reason>
[Nest] ERROR [TokenService] โ Refresh token expired: <details>
[Nest] ERROR [TokenService] โ Invalid refresh token - not found in database

# Frontend logs
[AuthClient] Refresh failed with status: 401
[ApiClient] ๐ Authentication failed - clearing local data
```

---

## ๐ Session Lifecycle

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. Login                                                    โ
โ    โ                                                        โ
โ    - Access Token (15 min) โ Stored in Memory             โ
โ    - Refresh Token (30 days) โ Stored in HttpOnly Cookie  โ
โ    - Session created in DB                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. Token Refresh (every 15 min)                            โ
โ    โ                                                        โ
โ    - Check if Refresh Token exists in DB                   โ
โ    - Check if Session is revoked                           โ
โ    - Check if Refresh Token expired                        โ
โ    - Rotate tokens (new Access + new Refresh)              โ
โ    - Update Session in DB                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. Session Expiry (after 30 days or manual logout)         โ
โ    โ                                                        โ
โ    - Mark Session as revoked                               โ
โ    - Clear cookies                                         โ
โ    - Redirect to login                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Security Features

### Token Rotation
- ูู ูุฑุฉ ูุชู ุชุฌุฏูุฏ ุงูู Access Tokenุ ูุชู ุฅูุดุงุก Refresh Token ุฌุฏูุฏ
- ุงูู Refresh Token ุงููุฏูู ููุฎุฒู ูู `previousRefreshTokenHash`
- ุฅุฐุง ุชู ุงุณุชุฎุฏุงู Token ูุฏูู (ุจุนุฏ 30 ุซุงููุฉ) = ุณุฑูุฉ ูุญุชููุฉ โ ุฅุจุทุงู ุฌููุน ุงูุฌูุณุงุช

### Grace Period (30 seconds)
- ูุญู ูุดููุฉ Race Condition
- ุฅุฐุง ุชู ุงุณุชุฎุฏุงู Token ูุฏูู ุฎูุงู 30 ุซุงููุฉ ูู ุงูุชุฏููุฑ = OK
- ุจุนุฏ 30 ุซุงููุฉ = ุงุนุชุจุงุฑู ูุญุงููุฉ ุณุฑูุฉ

### Max Rotation Count (100)
- ูููุน ุงูุชุฏููุฑ ุงููุงููุงุฆู
- ุจุนุฏ 100 ุชุฏููุฑุ ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู

---

## ๐๏ธ ุฅุตูุงุญ ุงููุดุงูู ุงูุดุงุฆุนุฉ

### ูุดููุฉ: "Session not found"
```bash
# 1. ุชุญูู ูู ูุฌูุฏ ุงูุฌูุณุฉ
npx prisma studio
# ุงูุชุญ Session table ูุงุจุญุซ ุนู userId

# 2. ุฅุฐุง ูู ุชูุฌุฏุ ูู ุจุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
```

### ูุดููุฉ: "Session expired"
```bash
# 1. ุชูุธูู ุงูุฌูุณุงุช ุงูููุชููุฉ
npm run ts-node src/scripts/cleanup-sessions.ts

# 2. ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
```

### ูุดููุฉ: "Token theft detected"
```bash
# 1. ุชุญูู ูู Security Logs
SELECT * FROM "SecurityLog" 
WHERE action = 'SUSPICIOUS_ACTIVITY' 
ORDER BY "createdAt" DESC;

# 2. ุฅุจุทุงู ุฌููุน ุฌูุณุงุช ุงููุณุชุฎุฏู ุงููุชุฃุซุฑ
# ูุชู ุชููุงุฆูุงู ุนูุฏ ุงูุชุดุงู ุงูุณุฑูุฉ
```

---

## ๐ ุงูุชุญุณููุงุช ุงููุทุจูุฉ

### Backend (`token.service.ts`)
โ Logging ูุญุณูู ููู ุฎุทูุฉ ูู ุนูููุฉ ุงูุชุฌุฏูุฏ
โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ูุจุงููุบุฉ ุงูุนุฑุจูุฉ
โ ุชุชุจุน ุฃูุถู ููุฌูุณุงุช ุงูููุชููุฉ

### Frontend (`api-client.ts`, `login/page.tsx`)
โ ูุนุงูุฌุฉ ุฃูุถู ูุญุงูุฉ ุงูุชูุงุก ุงูุฌูุณุฉ
โ ุฑุณุงูุฉ ุชูุถูุญูุฉ ุนูุฏ ุฅุนุงุฏุฉ ุงูุชูุฌูู ููู login
โ ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ ุจุดูู ูุงูู

### Scripts
โ `cleanup-sessions.ts` - ุชูุธูู ูุฅุญุตุงุฆูุงุช ุงูุฌูุณุงุช

---

## ๐ฏ Best Practices

1. **ูููุณุชุฎุฏููู:**
   - ูุง ุชุดุงุฑู Refresh Token ูุน ุฃุญุฏ
   - ุณุฌู ุฎุฑูุฌ ูู ุงูุฃุฌูุฒุฉ ุบูุฑ ุงููุณุชุฎุฏูุฉ
   - ุชุฌูุจ ุชุณุฌูู ุงูุฏุฎูู ูู ุฃุฌูุฒุฉ ุนุงูุฉ

2. **ูููุทูุฑูู:**
   - ุงุณุชุฎุฏู `cleanup-sessions.ts` ุจุดูู ุฏูุฑู (ูุซูุงู: cron job)
   - ุฑุงูุจ ุงูู Security Logs ุจุงูุชุธุงู
   - ุชุญูู ูู ุงูุฌูุณุงุช ุงููุดุทุฉ ูููุณุชุฎุฏููู ุงููุดุชุจู ุจูู

---

## ๐ ุงูุฏุนู

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:
1. ุชุญูู ูู ุงูู logs (Backend + Frontend)
2. ุดุบู `cleanup-sessions.ts`
3. ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (`Session` table)
4. ุฅุฐุง ูู ุชุญู ุงููุดููุฉุ ุงุชุตู ุจูุฑูู ุงูุชุทููุฑ

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2026-01-15  
**ุงูุฅุตุฏุงุฑ:** 1.0.0
